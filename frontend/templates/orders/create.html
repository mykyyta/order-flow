{% extends "base_form_page.html" %}
{% load static %}
{% load order_ui %}

{% block title %}Нове замовлення{% endblock %}

{% block form_content %}
<div class="space-y-4">
    {% if form.selected_product %}
    <div class="flex items-center justify-between gap-3">
        <div class="min-w-0">
            <p class="text-xs font-medium text-slate-500">Модель</p>
            <p class="truncate text-sm font-semibold text-slate-900">{{ form.selected_product.name }}</p>
        </div>
        <a href="{% url 'orders_create' %}" class="text-sm font-medium text-teal-700 hover:text-teal-800" data-change-product>
            Змінити
        </a>
    </div>
    <form method="post" action="{% url 'orders_create' %}" data-order-create-form>
        {% csrf_token %}
        <input type="hidden" name="product" value="{{ form.selected_product.id }}">

        <div class="space-y-4">
            {% if form.is_bundle_mode %}
            <div class="rounded-lg border border-slate-100 p-4 space-y-3">
                <h2 class="text-sm font-semibold text-slate-900">Компоненти</h2>
                {% if form.bundle_component_rows %}
                <div class="-mx-4 overflow-x-auto">
                    <table class="w-full min-w-[560px] text-sm">
                        <thead class="text-xs font-semibold text-slate-500">
                            <tr class="border-b border-slate-100">
                                <th class="px-4 py-2 text-left">Компонент</th>
                                <th class="px-4 py-2 text-left">Основний</th>
                                <th class="px-4 py-2 text-left">Другорядний</th>
                                <th class="px-4 py-2 text-left">Опції</th>
                            </tr>
                        </thead>
                        <tbody class="align-top">
                            {% for row in form.bundle_component_rows %}
                            <tr class="border-b border-slate-100 last:border-b-0">
                                <td class="px-4 py-3">
                                    <div class="font-medium text-slate-900">{{ row.component.name }}</div>
                                    <div class="text-xs text-slate-500">x{{ row.quantity }}</div>
                                </td>
                                <td class="px-4 py-3">
                                    {% with bf=form|get_form_field:row.primary_field_name %}
                                    {{ bf }}
                                    {% if bf.errors %}<p class="form-error mt-1">{{ bf.errors.0 }}</p>{% endif %}
                                    {% endwith %}
                                </td>
                                <td class="px-4 py-3">
                                    {% if row.show_secondary %}
                                    {% with bf=form|get_form_field:row.secondary_field_name %}
                                    {{ bf }}
                                    {% if bf.errors %}<p class="form-error mt-1">{{ bf.errors.0 }}</p>{% endif %}
                                    {% endwith %}
                                    {% else %}
                                    <span class="text-slate-400">—</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3">
                                    {% if row.embroidery_field_name %}
                                    {% with bf=form|get_form_field:row.embroidery_field_name %}
                                    <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                                        {% include "partials/form_checkbox_option.html" with field=bf label="Вишивка" %}
                                    </div>
                                    {% endwith %}
                                    {% else %}
                                    <span class="text-slate-400">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-sm text-slate-500">Спочатку додай компоненти в бандл.</p>
                {% endif %}
            </div>
            {% else %}
            <div class="rounded-lg border border-slate-100 p-4 space-y-3">
                <h2 class="text-sm font-semibold text-slate-900">Кольори</h2>
                {% include "partials/form_field.html" with field=form.primary_material_color label="Основний" %}
            {% if form.show_secondary_material_color %}
                {% include "partials/form_field.html" with field=form.secondary_material_color label="Другорядний" %}
            {% endif %}
            </div>
            {% endif %}

            <div class="rounded-lg border border-slate-100 p-4 space-y-3">
                <h2 class="text-sm font-semibold text-slate-900">Опції</h2>
                <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                    {% include "partials/form_checkbox_option.html" with field=form.is_etsy label="Etsy" %}
                    {% if not form.is_bundle_mode and form.selected_product.allows_embroidery %}
                    {% include "partials/form_checkbox_option.html" with field=form.is_embroidery label="Вишивка" %}
                    {% endif %}
                    {% include "partials/form_checkbox_option.html" with field=form.is_urgent label="Терміново" %}
                    {% if form.is_etsy.errors or form.is_embroidery.errors or form.is_urgent.errors %}
                    <p class="form-error w-full">{{ form.is_etsy.errors.0|default:form.is_embroidery.errors.0|default:form.is_urgent.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <div class="rounded-lg border border-slate-100 p-4 space-y-3">
                <h2 class="text-sm font-semibold text-slate-900">Коментар</h2>
                {% include "partials/form_field.html" with field=form.comment %}
            </div>

            <div class="pt-1">
                <button type="submit" class="btn-primary w-full min-h-[44px]">
                    Створити замовлення
                </button>
            </div>
        </div>
    </form>
    {% else %}
    <form method="get" action="{% url 'orders_create' %}" data-product-select-form>
        {% include "partials/form_field.html" with field=form.product label="Модель" %}
        <div class="pt-1">
            <button type="submit" class="btn-primary w-full min-h-[44px]" data-product-select-submit>
                Далі
            </button>
        </div>
    </form>
    {% endif %}
</div>
{% endblock %}

{% block form_page_footer %}
<div class="mt-4">
    <a href="{% url 'orders_active' %}" class="link-back">&larr; Назад до роботи</a>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/orders_create.js' %}"></script>
{% endblock %}
