{% extends "base_form_page.html" %}
{% load static %}
{% load order_ui %}

{% block title %}Нове замовлення{% endblock %}

{% block form_content %}
<div class="space-y-4">
    {% if form.selected_product %}
    <div class="flex items-center justify-between gap-3">
        <p class="truncate text-sm font-semibold text-slate-900">{{ form.selected_product.name }}</p>
        <a href="{% url 'orders_create' %}" class="text-sm font-medium text-teal-700 hover:text-teal-800" data-change-product>
            Змінити
        </a>
    </div>
    <form method="post" action="{% url 'orders_create' %}" data-order-create-form>
        {% csrf_token %}
        <input type="hidden" name="product" value="{{ form.selected_product.id }}">

        <div class="space-y-4">
            {% if form.is_bundle_mode %}
                {% if form.bundle_component_rows %}
                <div class="divide-y divide-slate-100">
                    {% for row in form.bundle_component_rows %}
                    <div class="p-4 space-y-3">
                        <div class="flex items-baseline justify-between gap-3">
                            <div class="min-w-0">
                                <p class="truncate text-sm font-medium text-slate-900">{{ row.component.name }}</p>
                            </div>
                            <p class="shrink-0 text-xs text-slate-500">x{{ row.quantity }}</p>
                        </div>
                        <div class="space-y-3">
                            {% with bf=form|get_form_field:row.primary_field_name %}
                            {% include "partials/form_field.html" with field=bf label="Колір" %}
                            {% endwith %}
                            {% if row.show_secondary %}
                            {% with bf=form|get_form_field:row.secondary_field_name %}
                            {% include "partials/form_field.html" with field=bf label="Додатковий" %}
                            {% endwith %}
                            {% endif %}
                            {% if row.embroidery_field_name %}
                            {% with bf=form|get_form_field:row.embroidery_field_name %}
                            <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                                {% include "partials/form_checkbox_option.html" with field=bf label="Вишивка" %}
                            </div>
                            {% endwith %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-sm text-slate-500">Спочатку додай компоненти в бандл.</p>
                {% endif %}
            {% else %}
            {% include "partials/form_field.html" with field=form.primary_material_color label="Колір" %}
            {% if form.show_secondary_material_color %}
            {% include "partials/form_field.html" with field=form.secondary_material_color label="Додатковий" %}
            {% endif %}
            {% endif %}

            <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                {% include "partials/form_checkbox_option.html" with field=form.is_etsy label="Etsy" %}
                {% if not form.is_bundle_mode and form.selected_product.allows_embroidery %}
                {% include "partials/form_checkbox_option.html" with field=form.is_embroidery label="Вишивка" %}
                {% endif %}
                {% include "partials/form_checkbox_option.html" with field=form.is_urgent label="Терміново" %}
                {% if form.is_etsy.errors or form.is_embroidery.errors or form.is_urgent.errors %}
                <p class="form-error w-full">{{ form.is_etsy.errors.0|default:form.is_embroidery.errors.0|default:form.is_urgent.errors.0 }}</p>
                {% endif %}
            </div>

            {% include "partials/form_field.html" with field=form.comment %}

            <div class="pt-1">
                <button type="submit" class="btn-primary w-full min-h-[44px]">
                    Створити замовлення
                </button>
            </div>
        </div>
    </form>
    {% else %}
    <form method="get" action="{% url 'orders_create' %}" class="space-y-4" data-product-select-form>
        {% include "partials/form_field.html" with field=form.product %}
        <button type="submit" class="btn-primary w-full min-h-[44px]" data-product-select-submit>
            Далі
        </button>
    </form>
    {% endif %}
</div>
{% endblock %}

{% block form_page_footer %}
<div class="mt-4">
    <a href="{% url 'orders_active' %}" class="link-back">&larr; Назад до роботи</a>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/orders_create.js' %}"></script>
{% endblock %}
