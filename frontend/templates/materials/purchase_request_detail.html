{% extends "base_form_page.html" %}
{% load order_ui %}

{% block form_content %}
<div class="space-y-4">
    <div class="flex items-start justify-between gap-3">
        <div class="min-w-0"></div>
        <div class="flex items-center gap-2 shrink-0">
            {% if purchase_request.status != "done" and purchase_request.status != "cancelled" %}
            <a href="{{ line_add_url }}" class="btn-primary">Додати</a>
            {% endif %}
            {% if actions %}
            {% include "partials/action_menu.html" with items=actions icon_only=True icon_style="horizontal" %}
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="divide-y divide-slate-100">
            {% for line in lines %}
            <div class="px-4 py-3">
                <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0 flex-1">
                        <div class="truncate text-sm font-medium text-slate-900">
                            {{ line.material.name }}
                            {% if line.material_color %}<span class="text-slate-400">·</span> {{ line.material_color.name }}{% endif %}
                            {% if line.requested_quantity is not None %}
                                <span class="text-slate-400">·</span>
                                <span class="font-semibold tabular-nums">{{ line.requested_quantity }}</span> {{ line.unit }}
                            {% endif %}
                        </div>
                        <div class="mt-0.5 text-xs text-slate-500 space-y-1">
                            {% if line.requested_quantity is None %}
                            <div class="truncate">К-сть не вказана</div>
                            {% endif %}
                            {% with po_lines=po_lines_by_request_line|get_item:line.id %}
                            {% if po_lines %}
                            <div class="truncate">
                                Замовлення:
                                {% for po_line in po_lines %}
                                    <a href="{% url 'purchase_detail' po_line.purchase_order_id %}" class="hover:underline">
                                        #{{ po_line.purchase_order_id }}
                                    </a>
                                    {% if po_line.supplier_offer %}
                                        <span class="text-slate-400">·</span> {{ po_line.supplier_offer.title|default:"—" }}
                                    {% endif %}
                                    {% if not forloop.last %},{% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% endwith %}
                            {% if line.notes %}
                            <div class="truncate">{{ line.notes }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="shrink-0 flex items-center gap-2">
                        {% if line.status == "done" %}
                            {% include "partials/badge.html" with label=line.get_status_display variant="success" size="sm" %}
                        {% elif line.status == "cancelled" %}
                            {% include "partials/badge.html" with label=line.get_status_display variant="danger" size="sm" %}
                        {% elif line.status == "ordered" %}
                            {% include "partials/badge.html" with label=line.get_status_display variant="primary" size="sm" %}
                        {% else %}
                            {% include "partials/badge.html" with label=line.get_status_display variant="info" size="sm" %}
                        {% endif %}

                        {% if line.status != "done" and line.status != "cancelled" %}
                            <a href="{% url 'purchase_request_line_order' line.id %}" class="btn-secondary">Замовити</a>
                            {% with items=line_action_items|get_item:line.id %}
                                {% if items %}
                                    {% include "partials/action_menu.html" with icon_only=True icon_style="horizontal" items=items %}
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            {% include "partials/empty_state.html" with message="Поки що позицій немає." %}
            {% endfor %}
        </div>
    </div>

    <div class="card">
        <div class="p-4 sm:p-5 space-y-3">
            <div class="text-xs text-slate-500">
                {{ purchase_request.warehouse.name }}
                <span class="text-slate-400">·</span>
                {{ purchase_request.get_status_display }}
            </div>
            <form method="post" class="space-y-4">
                {% csrf_token %}
                {% include "partials/form_field.html" with field=form.notes label="Коментар" %}
                <button type="submit" class="btn-primary">Зберегти</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
