# Ревізія проєкту OrderFlow (станом на 2026-02-07)

## Контекст і мета
Цей документ фіксує технічний стан проєкту перед запланованим рефакторингом і наступним розвитком. Огляд орієнтований на ризики, дефекти та технічний борг, які впливають на стабільність, безпеку та швидкість змін.

## Короткий опис архітектури
- **Django 5.1** моноліт: один проєкт `OrderFlow` + один основний додаток `orders`.
- База даних: **PostgreSQL** у `settings.py` (але є `db.sqlite3` у корені).
- Фронтенд: **HTML/Bootstrap** через шаблони.
- Інтеграція з **Telegram** через прямі HTTP виклики.
- Docker/Compose для локального запуску та деплою в Cloud Run.

## Критичні ризики (P0–P1)
1. **Відсутній захист для endpoint-а відкладених нотифікацій**
   - `orders/views.py: send_delayed_notifications` позначено `@csrf_exempt` і не має аутентифікації чи секрету.
   - Ризик спаму/зловживань та витоку інформації через сторонні виклики.

2. **Непрацездатний Docker Compose запуск**
   - `Dockerfile` запускає `runserver` на `${PORT}`, але в `docker-compose.yml` змінну `PORT` не задано, мапінг йде на `8000:8000`.
   - У більшості випадків контейнер не стартує або стартує з помилкою.

3. **Невірна/зламанa інтеграція Telegram-бота**
   - `orders/telegram_bot.py` звертається до `Order.status`, якого не існує, і не ініціалізує Django settings.
   - Скрипт у поточному вигляді не запускається та вводить в оману як "працююча" частина системи.

## Функціональні дефекти (P1–P2)
1. **Неконсистентність завершених замовлень**
   - `orders/views.py: current_orders_list` встановлює `finished_at`, але не скидає його при зміні статусу назад.
   - Замовлення може назавжди залишитись "завершеним" у UI та фільтрах.

2. **Відсутня обробка невалідної форми створення замовлення**
   - `orders/views.py: order_create` після `form.is_valid()` у будь-якому випадку робить redirect.
   - Користувач не бачить помилок, введені дані губляться.

3. **Ймовірний 500 при відсутності налаштувань нотифікацій**
   - `orders/views.py: notification_settings` звертається до `request.user.notification_settings` без fallback.
   - Якщо сигнал не спрацював або дані відновлені з бекапу — сторінка впаде.

## Безпека і конфігурація
- `DEBUG=True` у `settings.py` без умов — небезпечно для production.
- `SECRET_KEY` читається з `.env`, але відсутня перевірка на None.
- `CSRF_COOKIE_SAMESITE` і `SESSION_COOKIE_SAMESITE` встановлені в `None` — знижує захист від CSRF/CSRF-like атак.
- `CSRF_TRUSTED_ORIGINS` формує список навіть при порожньому env (виходить `['']`). Це може спричинити warnings та неправильну конфігурацію.

## Надійність та стабільність
- `orders/utils.py: send_tg_message` не має timeout і не обробляє виключення мережі — можливі зависання запитів.
- `Order.__str__` викликає `get_status()` і робить додаткові запити в БД (N+1 ефект у списках/адмінці).
- В шаблонах активне використання `order.get_status` для кожного рядка — масштабований N+1 у списку.

## Технічний борг
- `orders/urls.py` використовує `from .views import *` — ускладнює аналіз залежностей.
- Відсутні тести (`orders/tests.py` порожній).
- У репозиторії є `db.sqlite3` і `.env` (хоча вони в `.gitignore`) — можливо, вже потрапили в історію.
- Немає чіткої межі між бізнес-логікою та HTTP-рівнем (багато логіки у views).

## Рекомендації перед рефакторингом (короткий список)
1. Захистити `send_delayed_notifications` (auth token/подпис, IP allowlist або прив’язати до фонової задачі).
2. Узгодити `Dockerfile` і `docker-compose.yml` щодо порту (`PORT=8000` або 0.0.0.0:8000).
3. Виправити `order_create` для відображення помилок форми.
4. Зробити `finished_at` похідним або гарантувати коректне оновлення при зміні статусу.
5. Додати таймаут і обробку виключень для HTTP викликів Telegram.
6. Винести логіку формування статусу в `Order` (кешування або анотація в queryset).
7. Додати мінімальний набір тестів для критичних шляхів (створення, зміна статусу, нотифікації).

## Рекомендований напрямок рефакторингу (наступна стадія)
- Виділити доменний сервіс для замовлень (створення, зміна статусів, нотифікації).
- Визначити єдине джерело правди для статусу (або в `Order`, або строго в історії + last_status у БД).
- Нотифікації перенести у фон (Celery/APS або cron + management command) і логувати відправки.
- Визначити чітку конфігураційну схему для dev/prod (env файли, перевірки старту).

---

Якщо треба, підготую детальний план рефакторингу з оцінками, етапами та пріоритетами.
